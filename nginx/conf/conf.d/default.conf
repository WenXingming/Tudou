# =========================================================================================
# nginx 默认站点配置文件（默认存在于 nginx 镜像内，路径：/etc/nginx/conf.d/default.conf）
# 现在被自定义的反向代理配置文件覆盖，无实际作用，保留以备参考。

# server {
#     listen       80; # 监听 IPv4 的 80 端口
#     listen  [::]:80; # 监听 IPv6 的 80 端口
#     server_name  localhost; # 服务器名称

#     #access_log  /var/log/nginx/host.access.log  main;

#     location / {
#         root   /usr/share/nginx/html;
#         index  index.html index.htm;
#     }

#     #error_page  404              /404.html;

#     # redirect server error pages to the static page /50x.html
#     #
#     error_page   500 502 503 504  /50x.html;
#     location = /50x.html {
#         root   /usr/share/nginx/html;
#     }

#     # proxy the PHP scripts to Apache listening on 127.0.0.1:80
#     #
#     #location ~ \.php$ {
#     #    proxy_pass   http://127.0.0.1;
#     #}

#     # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
#     #
#     #location ~ \.php$ {
#     #    root           html;
#     #    fastcgi_pass   127.0.0.1:9000;
#     #    fastcgi_index  index.php;
#     #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
#     #    include        fastcgi_params;
#     #}

#     # deny access to .htaccess files, if Apache's document root
#     # concurs with nginx's one
#     #
#     #location ~ /\.ht {
#     #    deny  all;
#     #}
# }

# =========================================================================================




# =========================================================================================
# 自定义 nginx 反向代理配置文件

server {
#   listen 80 default_server; # 设置为默认服务器
  listen 80 ; # 设置为默认服务器
  server_name _; # 匹配所有主机名

  location / {
    proxy_pass http://0.0.0.0:8080; # # --network host 模式下，0.0.0.0 指的是主机本机（容器内的 0.0.0.0、127.0.0.1 和主机的 0.0.0.0、127.0.0.1 是相同的）
    # proxy_http_version 1.1; # 使用 HTTP/1.1 以支持持久连接
    # proxy_set_header Connection ""; # 清除 Connection 头以启用持久连接
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}

# 已看到你后端监听 0.0.0.0:8080。现在 Nginx 能启动但未反代，多半是命中到了镜像自带的默认站点 default.conf（或非默认 server 抢不到匹配）。
# 我已更新 forward_host.conf 为默认 server，并新增 empty.conf 用来覆盖默认站点。
# 推荐：使用 host 网络（前提：主机 80 端口空闲）

# cd 到 Tudou 根目录（/home/wxm/Tudou，因为使用到了 $(pwd) 命令），运行以下命令启动 Nginx 容器：
# sudo docker run \
#   --name nginx-forward \
#   -d \
#   --network host \
#   -v $(pwd)/nginx/conf/nginx.conf:/etc/nginx/nginx.conf:ro \
#   -v $(pwd)/nginx/conf/conf.d:/etc/nginx/conf.d:ro \
#   -v $(pwd)/nginx/log:/var/log/nginx \
#   -v $(pwd)/nginx/html:/usr/share/nginx/html:ro \
#   nginx:trixie-perl
#
# 若容器立即退出，请先检查：
#   1) 主机 80 端口是否被占用：sudo ss -ltnp | grep ':80 ' （其他容器正在占用）
#   2) 查看容器日志：sudo docker logs nginx-forward
# 常见错误：bind() 80 address already in use（说明主机 80 被占用）

# =========================================================================================
