%%{init: {
    "theme": "default",
    "themeVariables": {
        "fontFamily": "Times New Roman",
        "fontSize": "18px"
    }
}}%%
sequenceDiagram
    autonumber
    title Tudou 网络库回调触发关系（精简版）

    participant EventLoop
    participant EpollPoller
    participant Channel
    participant Acceptor
    participant TcpConnection
    participant TcpServer
    actor App as 上层应用

    %% 新连接到来：从监听 fd 上的读事件一路触发到上层

    EventLoop ->> EpollPoller: poll()
    EpollPoller -->> EventLoop: activeChannels(listen-fd)
    EventLoop ->> Channel: handle_events() on listen-fd
    Channel ->> Acceptor: handle_read()  // readCallback

    Acceptor ->> Acceptor: accept() 得到 connFd
    Acceptor ->> TcpServer: connectCallback(connFd)
    TcpServer ->> TcpConnection: 构造连接对象并注册回调
    TcpServer ->> App: connectionCallback(conn)  // 通知上层有新连接

    %% 有数据可读：从 conn-fd 上的读事件触发到应用层 message 回调

    EventLoop ->> EpollPoller: poll()
    EpollPoller -->> EventLoop: activeChannels(conn-fd, EPOLLIN)
    EventLoop ->> Channel: handle_events() on conn-fd
    Channel ->> TcpConnection: handle_read() -> read_callback()

    TcpConnection ->> TcpConnection: readBuffer.read_from_fd()
    TcpConnection ->> TcpConnection: handle_message()
    TcpConnection ->> TcpServer: messageCallback(conn)
    TcpServer ->> App: messageCallback(conn)  // 上层处理业务 / HTTP 请求

    %% 上层发送响应：从 App 的 send 调用触发到底层写 fd

    App ->> TcpConnection: send(response)
    TcpConnection ->> TcpConnection: writeBuffer.write_to_buffer()
    TcpConnection ->> Channel: enable_writing()

    EventLoop ->> EpollPoller: poll()
    EpollPoller -->> EventLoop: activeChannels(conn-fd, EPOLLOUT)
    EventLoop ->> Channel: handle_events() on conn-fd (write)
    Channel ->> TcpConnection: handle_write() -> write_callback()
    TcpConnection ->> TcpConnection: writeBuffer.write_to_fd()

    %% 连接关闭：从底层事件一路触发到上层的关闭回调

    alt 对端关闭或出错
        EventLoop ->> EpollPoller: poll()
        EpollPoller -->> EventLoop: activeChannels(conn-fd, EPOLLIN/HUP/ERR)
        EventLoop ->> Channel: handle_events()
        Channel ->> TcpConnection: handle_close()/handle_error()
        TcpConnection ->> TcpConnection: handle_close()
        TcpConnection ->> TcpServer: closeCallback(conn)
        TcpServer ->> TcpServer: remove_connection(conn)
        TcpServer ->> App: connectionCallback(conn 关闭)  // 如果你选择在这里通知上层
    end